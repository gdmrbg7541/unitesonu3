<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title> ØªÙ…Ø±ÙŠÙ† Ù…Ù„Ø¡ Ø§Ù„ÙØ±Ø§Øº</title>
    <link href="https://fonts.googleapis.com/css2?family=Markazi+Text:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        /* --- Temel Ayarlar --- */
        :root {
            --accent-color: #007bff;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --bg-light: #f8f9fa;
            --font-arabic: 'Markazi Text', 'Tahoma', 'Arial', sans-serif;
            --global-question-font-size: 50px; /* JS ile gÃ¼ncellenecek */
        }

        body {
            font-family: var(--font-arabic);
            background-color: #333; 
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100vw;
            height: 100vh;
            margin: 0;
            overflow: hidden;
            font-weight: 400;
        }

        /* --- KUTU YAPISI --- */
        .activity-container {
            position: relative;
            background: #ffffff;
            border-radius: 12px;
            box-shadow: 0 0 50px rgba(0, 0, 0, 0.5);
            overflow: hidden;
            display: flex;
            flex-direction: column;

            /* VarsayÄ±lan (YATAY) OranÄ±: 16:9 */
            aspect-ratio: 16 / 9;
            width: min(95vw, 95vh * 16 / 9);
            height: min(95vh, 95vw * 9 / 16);
        }

        /* Tam Ekran Modu */
        body.fullscreen .activity-container {
            width: min(100vw, 100vh * 16 / 9);
            height: min(100vh, 100vw * 9 / 16);
            border-radius: 0;
        }

        /* =========================================
           ROTATION WARNING (YATAY Ã‡EVÄ°R UYARISI)
           ========================================= */
        #rotate-message {
            display: none; 
            position: fixed;
            top: 0; left: 0;
            width: 100vw; height: 100vh;
            background-color: #222;
            z-index: 10000;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .phone-icon {
            width: 80px; height: 140px;
            border: 6px solid #f0f0f0; border-radius: 10px;
            position: relative;
            animation: rotateAnimation 2.5s infinite ease-in-out;
        }
        
        .phone-icon::before {
            content: ''; position: absolute;
            top: 10px; left: 50%; transform: translateX(-50%);
            width: 20%; height: 4px; background: #f0f0f0; border-radius: 2px;
        }

        @keyframes rotateAnimation {
            0% { transform: rotate(0deg); opacity: 1; }
            30% { transform: rotate(0deg); }
            60% { transform: rotate(-90deg); opacity: 1; }
            80% { transform: rotate(-90deg); opacity: 0; }
            100% { transform: rotate(0deg); opacity: 0; }
        }

        /* Cihaz Dikey (Portrait) ise OYUNU GÄ°ZLE */
        @media (orientation: portrait) {
            .activity-container { display: none !important; }
            #rotate-message { display: flex !important; }
        }

        /* --- Header (BaÅŸlÄ±k AlanÄ±) --- */
        .header {
            padding: 1% 2%;
            border-bottom: 1px solid #dee2e6;
            display: flex; 
            justify-content: space-between;
            align-items: center;
            background: #fff;
            height: 10%; 
            box-sizing: border-box;
        }
        
        .progress-wrapper { 
            flex: 1; 
            display: flex; 
            align-items: center; 
            gap: 10px;
            /* DÃœZELTME: Ä°lerleme Ã§ubuÄŸunun aÅŸÄ±rÄ± bÃ¼yÃ¼mesini engelle */
            max-width: 250px; 
        }
        
        #instruction-text { 
            flex: 2; text-align: center; 
            font-size: clamp(1.5rem, 5vh, 3rem); 
            font-weight: 700; color: #555;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
            padding: 0 10px;
        }
        
        .back-button-container { flex: 1; display: flex; justify-content: flex-end; gap: 8px; }
        
        .icon-btn {
            background: #f0f0f0; color: #555; border: 1px solid #ccc; border-radius: 8px;
            cursor: pointer; width: clamp(35px, 6vh, 55px); height: clamp(35px, 6vh, 55px);
            padding: 0; display: flex; align-items: center; justify-content: center;
        }
        .icon-btn:hover { background: #e0e0e0; }
        .icon-btn svg { width: 60%; height: 60%; fill: currentColor; }

        #fullscreen-btn .icon-open { display: block; }
        #fullscreen-btn .icon-close { display: none; }
        body.fullscreen #fullscreen-btn .icon-open { display: none; }
        body.fullscreen #fullscreen-btn .icon-close { display: block; }

        #progress-display { font-size: clamp(1rem, 2vh, 1.8rem); font-weight: bold; color: var(--accent-color); }
        .progress-bar-container { flex-grow: 1; height: 1.5vh; background-color: #e0e0e0; border-radius: 1vh; overflow: hidden; }
        #progress-bar { height: 100%; width: 0%; background-color: var(--accent-color); transition: width 0.4s ease; }

        /* --- Oyun AlanÄ± --- */
        .activity-area {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden; 
            position: relative;
        }

        .fill-in-blank-container {
            display: flex; flex-direction: column;
            align-items: center; 
            justify-content: center;
            width: 100%; height: 100%;
            padding: 1% 3%; box-sizing: border-box;
            gap: 2%; 
        }
        
        /* --- SORU METNÄ° VE INPUT --- */
        .question-wrapper {
            flex-grow: 1; 
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden; 
            position: relative; 
        }

        .question-text {
            /* JS tarafÄ±ndan hesaplanan global boyutu kullan */
            font-size: var(--global-question-font-size); 
            font-weight: 700; color: #212529; text-align: center;
            white-space: nowrap; 
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1.2;
            padding: 0 10px;
        }

        .answer-input {
            font-family: var(--font-arabic);
            border: 2px solid var(--accent-color); border-radius: 8px;
            padding: 0 10px; 
            min-width: 2em; 
            text-align: center; margin: 0 0.2em; 
            height: 1.4em; 
            background: #f8f9fa; color: #333;
            display: inline-flex; align-items: center; justify-content: center;
            vertical-align: middle;
        }

        /* --- GÄ°ZLÄ° CETVEL --- */
        #hidden-ruler {
            visibility: hidden;
            position: absolute;
            white-space: nowrap;
            top: 0; left: 0;
            font-weight: 700;
            pointer-events: none;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: var(--font-arabic);
            padding: 0 10px;
        }
        
        /* --- KLAVYE ALANI --- */
        .keyboard-area {
            width: 100%;
            display: flex; flex-direction: column; align-items: center;
            margin-bottom: 0.5vh;
            flex-shrink: 0; 
        }

        .keyboard-container {
            width: 100%; 
            max-width: 90%; 
            direction: rtl; user-select: none;
            padding: 10px; box-sizing: border-box;
            background: rgba(0,0,0,0.02); border-radius: 10px;
        }
        
        .key-row { 
            display: flex; 
            justify-content: center; 
            gap: 1vh; 
            margin-bottom: 1vh; 
        }
        
        .key {
            font-family: var(--font-arabic);
            font-size: clamp(1.4rem, 3.5vh, 2.5rem); 
            font-weight: 700;
            height: clamp(45px, 8vh, 80px); 
            flex-grow: 1; flex-basis: 0; max-width: 12%;
            border-radius: 8px; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            border: 1px solid rgba(0,0,0,0.1);
            transition: transform 0.1s, box-shadow 0.1s;
        }
        .key:active { transform: scale(0.95); }
        .key.backspace { max-width: 15%; color: white; }

        .scramble-controls { display: flex; justify-content: center; gap: 20px; margin-top: 1.5vh; }
        #check-scramble-btn, #reset-scramble-btn {
            padding: 1.2vh 3.5vh;
            font-size: clamp(1.4rem, 2.8vh, 2.4rem);
            font-family: var(--font-arabic); font-weight: 700;
            border: none; border-radius: 8px; cursor: pointer; color: white;
        }
        #check-scramble-btn { background-color: var(--success-color); }
        #reset-scramble-btn { background-color: var(--danger-color); }


        /* --- MOBÄ°L YATAY Ã–ZEL AYARLAR --- */
        @media (max-height: 500px) and (orientation: landscape) {
            .header { 
                height: 15%; 
                padding: 0 10px; 
            }
            
            /* DÃœZELTME: Ä°lerleme Ã§ubuÄŸunu sÄ±nÄ±rla, baÅŸlÄ±ÄŸa yer aÃ§ */
            .progress-wrapper {
                max-width: 25%; /* Ekranda %25'ten fazla yer kaplamasÄ±n */
            }

            /* DÃœZELTME: BaÅŸlÄ±ÄŸÄ± gÃ¶ster ve alan tanÄ± */
            #instruction-text { 
                display: block; /* Geri getirildi */
                font-size: clamp(1rem, 5vh, 1.5rem); /* Mobilde Ã§ok bÃ¼yÃ¼k olmasÄ±n */
                flex: 3; /* Esnek alanda Ã¶ncelik baÅŸlÄ±kta */
            }

            .keyboard-container { max-width: 98%; padding: 2px;}
            .key-row { gap: 12px; margin-bottom: 8px; }
            .key { height: 10vh; font-size: 7vh; max-width: unset; }
            .scramble-controls { margin-top: 5px; gap: 15px; }
            #check-scramble-btn, #reset-scramble-btn { padding: 0.8vh 2.5vh; font-size: 5vh; }
        }
        
        /* --- Geri Bildirim --- */
        .feedback-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.95);
            display: flex; justify-content: center; align-items: center;
            font-size: 15vh; z-index: 200;
            visibility: hidden; opacity: 0; transition: opacity 0.3s ease;
            flex-direction: column;
        }
        .feedback-overlay.show { visibility: visible; opacity: 1; }
        .feedback-overlay .correct { color: var(--success-color); }
        .feedback-overlay .incorrect { color: var(--danger-color); }
        
        #feedback-details { display: none; flex-direction: column; align-items: center; margin-top: 20px; width: 90%; text-align: center; }
        #feedback-correct-answer {
            font-size: clamp(1.5rem, 4vh, 3.5rem); font-weight: 700; color: #333;
            background: #fff; padding: 2vh; border-radius: 10px; border: 2px solid #ccc; margin-bottom: 2vh;
        }
        #feedback-ok-button {
            font-size: 3vh; background-color: var(--success-color); color: white;
            border: none; border-radius: 50%; width: 8vh; height: 8vh; cursor: pointer;
        }
        
        /* --- BitiÅŸ EkranÄ± --- */
        #finish-screen { 
            text-align: center; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            height: 100%; 
            gap: 3vh; 
        }
        #finish-screen p { margin: 0; }
        .score-display { font-size: 4vh; direction: ltr; margin: 0; }
        #replay-button { font-size: 6vh; background: none; border: none; cursor: pointer; border-radius: 50%; }

    </style>
</head>
<body>

    <div id="rotate-message">
        <div class="phone-icon"></div>
    </div>

    <div class="activity-container">
        <div class="header">
            <div class="progress-wrapper">
                <div id="progress-display">...</div> 
                <div class="progress-bar-container">
                    <div id="progress-bar"></div>
                </div>
            </div>
            
            <div id="instruction-text">...</div>

            <div class="back-button-container">
                <button id="fullscreen-btn" class="icon-btn">
                    <svg class="icon-open" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M5 10h2V7h3V5H5v5zM14 5v2h3v3h2V5h-5zM5 19v-5h2v3h3v2H5zM14 19v-2h3v-3h2v5h-5z"/></svg>
                    <svg class="icon-close" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M5 16h3v3h2v-5H5v2zm3-8H5v2h5V5H8v3zm6 11h2v-3h3v-2h-5v5zm2-11V5h-2v5h5V8h-3z"/></svg>
                </button>
                <a href="index.html" class="icon-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg>
                </a>
            </div>
        </div>

        <div class="activity-area" id="activity-area"></div>

        <div class="feedback-overlay" id="feedback-overlay">
            <span id="feedback-icon"></span>
            <div id="feedback-details">
                <div id="feedback-correct-answer"></div>
                <button id="feedback-ok-button">âœ”</button>
            </div>
        </div>
    </div>

    <script>
        const colorMap={'Ø¨':'#a0c4ff','Øª':'#a0c4ff','Ø«':'#a0c4ff','Ù†':'#a0c4ff','ÙŠ':'#a0c4ff','Ø¬':'#caffbf','Ø­':'#caffbf','Ø®':'#caffbf','Ø¯':'#fdffb6','Ø°':'#fdffb6','Ø±':'#ffd6a5','Ø²':'#ffd6a5','Ø³':'#ffadad','Ø´':'#ffadad','Øµ':'#bdb2ff','Ø¶':'#bdb2ff','Ø·':'#9bf6ff','Ø¸':'#9bf6ff','Ø¹':'#ffc6ff','Øº':'#ffc6ff','Ù':'#b9f6ca','Ù‚':'#b9f6ca','Ù‡':'#b3e5fc','Ø©':'#b3e5fc','Ø¡':'#ffccbc','Ø¤':'#ffccbc','Ø¦':'#ffccbc','Ø§':'#e0e0e0','Ù„':'#e0e0e0','Ùƒ':'#d1c4e9','Ù…':'#f8bbd0','Ùˆ':'#c5cae9'};
        const defaultColor='#FFFFFF';
        const backspaceBg = '#E53935';
        
        function getDarkerColor(hex) {
            if (!hex || hex === '#FFFFFF') hex = '#CCCCCC'; 
            if (hex.length === 4) { hex = `#${hex[1]}${hex[1]}${hex[2]}${hex[2]}${hex[3]}${hex[3]}`; }
            let r = parseInt(hex.slice(1, 3), 16);
            let g = parseInt(hex.slice(3, 5), 16);
            let b = parseInt(hex.slice(5, 7), 16);
            r = Math.floor(r * 0.85); g = Math.floor(g * 0.85); b = Math.floor(b * 0.85);
            return `#${r.toString(16).padStart(2, '0')}${g.toString(16).padStart(2, '0')}${b.toString(16).padStart(2, '0')}`;
        }
        
        const backspaceShadow = getDarkerColor(backspaceBg);
        
        const keyRows = [
            ["Ø¯","Ø¬","Ø­","Ø®","Ù‡","Ø¹","Øº","Ù","Ù‚","Ø«","Øµ","Ø¶"],
            ["Ø·","Ùƒ","Ù…","Ù†","Øª","Ø§","Ù„","Ø¨","ÙŠ","Ø³","Ø´","Ø°"],
            ["Backspace", "Ø¸","Ø²","Ùˆ","Ø©","Ù‰","Ø±","Ø¤","Ø¡","Ø¦"] 
        ];

       const activitiesData = [
    // --- EVÄ°N BÃ–LÃœMLERÄ° (Tek ve Net Cevaplar) ---
    { pre: "Ø£ÙÙ…Ù‘ÙŠ ØªÙØ·Ù’Ø¨ÙØ®Ù Ø§Ù„Ø·ÙÙ‘Ø¹Ø§Ù… ÙÙŠ", post: "", a: "Ø§Ù„Ù’Ù…ÙØ·Ù’Ø¨ÙØ®", hint: "Evin BÃ¶lÃ¼mÃ¼ (Mutfak)" },
    { pre: "Ø£ÙØºÙ’Ø³ÙÙ„Ù ÙˆÙØ¬Ù’Ù‡ÙŠ ÙˆÙÙŠÙØ¯ÙÙŠÙÙ‘ ÙÙŠ", post: "", a: "Ø§Ù„Ù’Ø­ÙÙ…Ù‘Ø§Ù…", hint: "Evin BÃ¶lÃ¼mÃ¼ (Banyo)" },
    { pre: "Ø£ÙÙ†Ø§Ù…Ù Ù„ÙÙŠÙ’Ù„Ù‹Ø§ ÙÙŠ ØºÙØ±Ù’ÙÙØ©", post: "", a: "Ø§Ù„Ù†ÙÙ‘ÙˆÙ’Ù…", hint: "Oda (Yatak OdasÄ±)" },
    { pre: "Ù†ÙØ¬Ù’Ù„ÙØ³Ù Ù…ÙØ¹Ù Ø§Ù„Ø¶ÙÙ‘ÙŠÙˆÙ ÙÙŠ ØºÙØ±Ù’ÙÙØ©", post: "", a: "Ø§Ù„Ù’Ø¬ÙÙ„ÙˆØ³", hint: "Oda (Oturma OdasÄ±)" },
    { pre: "ÙŠÙˆØ¬ÙØ¯Ù Ø­ÙÙˆÙ’Ù„Ù Ø§Ù„Ù’Ø¨ÙÙŠÙ’Øª", post: "ÙˆØ§Ø³ÙØ¹ÙØ©", a: "Ø­ÙØ¯ÙŠÙ‚ÙØ©", hint: "Ä°sim (BahÃ§e)" },
    { pre: "Ù†ÙØ´Ø§Ù‡ÙØ¯Ù", post: "ÙÙŠ ØºÙØ±Ù’ÙÙØ© Ø§Ù„Ù’Ø¬ÙÙ„ÙˆØ³", a: "Ø§Ù„ØªÙÙ‘Ù„Ù’ÙØ§Ø²", hint: "EÅŸya (Televizyon)" },

    // --- AÄ°LE VE KÄ°ÅÄ°LER (1 veya 2 CevaplÄ±) ---
    { pre: "Ù‡ÙØ°Ø§ Ø£ÙØ¨ÙŠ ÙˆÙ Ù‡ÙØ°ÙÙ‡Ù", post: "", a: ["Ø£ÙÙ…Ù‘ÙŠ", "ÙˆØ§Ù„ÙØ¯ÙØªÙŠ"], hint: "Aile Ãœyesi (Annem)" }, 
    { pre: "Ø£ÙÙ†Ø§", post: "Ø£ÙØ³Ù’Ø±ÙØªÙŠ ÙƒÙØ«ÙŠØ±Ù‹Ø§", a: "Ø£ÙØ­ÙØ¨ÙÙ‘", hint: "Fiil (Seviyorum)" },
    { pre: "Ø£ÙØ®Ù’ØªÙŠ", post: "ØªÙÙ„Ù’Ø¹ÙØ¨Ù Ø¨ÙØ§Ù„Ø¯ÙÙ‘Ù…Ù’ÙŠÙØ©", a: "Ø§Ù„ØµÙÙ‘ØºÙŠØ±ÙØ©", hint: "SÄ±fat (KÃ¼Ã§Ã¼k - MÃ¼ennes)" },
    { pre: "ØªÙØªÙÙƒÙÙˆÙÙ‘Ù†Ù", post: "Ù…ÙÙ†Ù’ Ø®ÙÙ…Ù’Ø³ÙØ©Ù Ø£ÙÙÙ’Ø±Ø§Ø¯", a: ["Ø£ÙØ³Ù’Ø±ÙØªÙŠ", "Ø¹Ø§Ø¦ÙÙ„ÙØªÙŠ"], hint: "Ä°sim (Ailem)" },

    // --- YER, YÃ–N VE ADRES (Net Cevaplar) ---
    { pre: "", post: "ØªÙØ³Ù’ÙƒÙÙ†Ù ÙŠØ§ Ø£Ø­Ù’Ù…ÙØ¯ØŸ", a: "Ø£ÙÙŠÙ’Ù†Ù", hint: "Soru EdatÄ± (Nerede)" },
    { pre: "Ø¨ÙÙŠÙ’ØªÙŠ", post: "Ù…ÙÙ†Ù Ø§Ù„Ù’Ù…ÙØ¯Ù’Ø±ÙØ³ÙØ©", a: "Ù‚ÙØ±ÙŠØ¨", hint: "SÄ±fat (YakÄ±n)" },
    { pre: "Ø§Ù„Ù’Ù…ÙØ¯Ù’Ø±ÙØ³ÙØ©", post: "Ø¹ÙÙ†Ù Ø§Ù„Ù’Ø¨ÙÙŠÙ’Øª", a: "Ø¨ÙØ¹ÙŠØ¯ÙØ©", hint: "SÄ±fat (Uzak)" },
    { pre: "Ø¨ÙÙŠÙ’ØªÙŠ ÙÙŠ", post: "Ø§Ù„Ù’Ø£ÙÙˆÙÙ‘Ù„", a: "Ø§Ù„Ø·Ù‘Ø§Ø¨ÙÙ‚", hint: "Ä°sim (Kat)" },
    { pre: "", post: "Ø¹ÙÙ†ÙˆØ§Ù†Ù Ø¨ÙÙŠÙ’ØªÙÙƒØŸ", a: ["Ù…Ø§", "Ù…Ø§Ø°Ø§"], hint: "Soru EdatÄ± (Ne)" },
    { pre: "Ø¨ÙÙŠÙ’ØªÙŠ ÙÙŠ Ø´Ø§Ø±ÙØ¹", post: "", a: ["Ø§Ù„Ù’ÙˆÙØ·ÙÙ†", "Ø§Ù„Ø³ÙÙ‘Ù„Ø§Ù…"], hint: "Ã–zel Ä°sim (Cadde adÄ± Ã¶rn: Vatan/BarÄ±ÅŸ)" }, // Burada ipucuna gÃ¶re Ã¶ÄŸrenci herhangi birini yazsa kabul olur.
    
    // --- GÃœNLÃœK Ä°ÅLER VE SIFATLAR ---
    { pre: "Ø£ÙÙ†Ø§", post: "Ù…ÙØ¨ÙÙƒÙÙ‘Ø±Ù‹Ø§ Ø¬ÙØ¯Ù‹Ù‘Ø§", a: "Ø£ÙØ³Ù’ØªÙÙŠÙ’Ù‚ÙØ¸Ù", hint: "Fiil (UyanÄ±yorum)" },
    { pre: "Ø£ÙØªÙÙ†Ø§ÙˆÙÙ„Ù", post: "ÙÙÙŠ Ø§Ù„ØµÙÙ‘Ø¨Ø§Ø­", a: "Ø§Ù„Ù’ÙÙØ·ÙˆØ±", hint: "Ã–ÄŸÃ¼n (KahvaltÄ±)" },
    { pre: "Ø£ÙØ°Ù’Ù‡ÙØ¨Ù Ø¥ÙÙ„Ù‰", post: "Ø¨ÙØ§Ù„Ù’Ø­Ø§ÙÙÙ„ÙØ©", a: "Ø§Ù„Ù’Ù…ÙØ¯Ù’Ø±ÙØ³ÙØ©", hint: "Yer (Okul)" },
    { pre: "Ø§Ù„Ù’Ø¨ÙÙŠÙ’ØªÙ", post: "ÙˆÙ Ø¬ÙÙ…ÙŠÙ„ÙŒ", a: ["ÙƒÙØ¨ÙŠØ±", "ÙˆØ§Ø³ÙØ¹"], hint: "SÄ±fat (BÃ¼yÃ¼k/GeniÅŸ)" }
];

        const activityArea = document.getElementById('activity-area');
        const instructionText = document.getElementById('instruction-text');
        const progressDisplay = document.getElementById('progress-display');
        const progressBar = document.getElementById('progress-bar');
        const feedbackOverlay = document.getElementById('feedback-overlay');
        const feedbackIcon = document.getElementById('feedback-icon');
        const feedbackDetails = document.getElementById('feedback-details');
        const feedbackCorrectAnswer = document.getElementById('feedback-correct-answer');
        const feedbackOkButton = document.getElementById('feedback-ok-button');
        const fullscreenButton = document.getElementById('fullscreen-btn');

        let audioCtx = null;
        let allActivitiesData = [];     
        let activityQueue = [];         
        let currentActivityIndex = 0;   
        let grandTotalActivities = 0;   
        let currentRound = 0;           
        const questionsPerRound = 10;   
        let totalRounds = 0;            
        let totalQuestionsInGame = 0;   
        let scoreCorrect = 0;      
        let scoreIncorrect = 0;    
        let longestDataItem = null;

        function initAudioContext() {
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        }
        
        function playSound(type) {
            if (!audioCtx) return; 
            const oscillator = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            oscillator.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            oscillator.type = 'sine';
            const now = audioCtx.currentTime;

            if (type === 'touch') {
                oscillator.frequency.setValueAtTime(200, now);
                gainNode.gain.setValueAtTime(0.1, now);
                gainNode.gain.exponentialRampToValueAtTime(0.0001, now + 0.1);
                oscillator.start(now); oscillator.stop(now + 0.1);
            } else if (type === 'correct') {
                oscillator.frequency.setValueAtTime(440, now);
                oscillator.frequency.linearRampToValueAtTime(880, now + 0.2);
                gainNode.gain.setValueAtTime(0.15, now);
                gainNode.gain.exponentialRampToValueAtTime(0.0001, now + 0.2);
                oscillator.start(now); oscillator.stop(now + 0.2);
            } else if (type === 'incorrect') {
                oscillator.frequency.setValueAtTime(300, now);
                oscillator.frequency.linearRampToValueAtTime(150, now + 0.3);
                gainNode.gain.setValueAtTime(0.15, now);
                gainNode.gain.exponentialRampToValueAtTime(0.0001, now + 0.3);
                oscillator.start(now); oscillator.stop(now + 0.3);
            }
        }
        
        document.body.addEventListener('click', function() { initAudioContext(); }, { once: true });

        function toggleFullScreen() {
            if (!document.fullscreenElement) { document.documentElement.requestFullscreen(); } 
            else { if (document.exitFullscreen) document.exitFullscreen(); }
        }
        
        function checkFullScreen() {
             if (document.fullscreenElement) document.body.classList.add('fullscreen');
             else document.body.classList.remove('fullscreen');
        }
        
        if(fullscreenButton) fullscreenButton.addEventListener('click', toggleFullScreen);
        document.addEventListener('fullscreenchange', checkFullScreen);

        function shuffle(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }
        
        function normalizeForCheck(text) {
            if (!text) return "";
            let newText = text.replace(/[\u064B-\u065F]/g, ""); 
            newText = newText.replace(/[Ø£Ø¥Ø¢]/g, "Ø§").replace(/[Ù‰]/g, "ÙŠ"); 
            return newText;
        }

        function findLongestData() {
            let maxLen = 0;
            let longest = activitiesData[0];
            activitiesData.forEach(item => {
                let currentLen = (item.pre ? item.pre.length : 0) + (item.post ? item.post.length : 0);
                if (currentLen > maxLen) {
                    maxLen = currentLen;
                    longest = item;
                }
            });
            longestDataItem = longest;
        }

        function calculateGlobalFontSize() {
            if (!longestDataItem) return;

            const wrapper = document.querySelector('.question-wrapper');
            if (!wrapper) return;

            let ruler = document.getElementById('hidden-ruler');
            if (!ruler) {
                ruler = document.createElement('div');
                ruler.id = 'hidden-ruler';
                wrapper.appendChild(ruler);
            }
            ruler.innerHTML = ''; 

            const preSpan = document.createElement('span'); 
            preSpan.textContent = longestDataItem.pre;
            
            const inputDiv = document.createElement('div'); 
            inputDiv.className = 'answer-input'; 
            
            const postSpan = document.createElement('span');
            postSpan.textContent = longestDataItem.post;

            ruler.appendChild(preSpan);
            ruler.appendChild(inputDiv);
            ruler.appendChild(postSpan);

            let fontSize = wrapper.clientHeight * 0.7; 
            const maxWidth = wrapper.clientWidth * 0.98; 

            ruler.style.fontSize = fontSize + 'px';

            while ((ruler.scrollWidth > maxWidth) && fontSize > 10) {
                fontSize = fontSize * 0.95; 
                ruler.style.fontSize = fontSize + 'px';
            }

            document.documentElement.style.setProperty('--global-question-font-size', fontSize + 'px');
        }

        window.addEventListener('resize', calculateGlobalFontSize);


        function loadActivity() {
            activityArea.innerHTML = '';
            updateProgress(); 
            const activityData = activityQueue[currentActivityIndex]; 
            instructionText.textContent = "Ø§ÙÙ…Ù’Ù„ÙØ£ Ø§Ù„ÙÙØ±Ø§Øº Ø¨ÙØ§Ù„ÙƒÙÙ„ÙÙ…ÙØ© Ø§Ù„Ù…ÙÙ†Ø§Ø³ÙØ¨ÙØ©.";
            buildFillInTheBlank(activityData);
            
            setTimeout(calculateGlobalFontSize, 10);
        }

        
        function buildFillInTheBlank(data) {
            const container = document.createElement('div');
            container.className = 'fill-in-blank-container';

            const questionWrapper = document.createElement('div');
            questionWrapper.className = 'question-wrapper';

            const questionText = document.createElement('div');
            questionText.className = 'question-text';
            
            const preText = document.createElement('span'); preText.textContent = data.pre;
            const answerInput = document.createElement('div');
            answerInput.id = 'answer-input'; answerInput.className = 'answer-input';
            const postText = document.createElement('span');
            
            let postContent = data.post; 
            if (postContent === "") postContent = "."; 
            else {
                const trimmedPost = postContent.trim();
                const lastChar = trimmedPost.charAt(trimmedPost.length - 1);
                if (lastChar === 'ØŸ' || lastChar === '?' || lastChar === '!') postContent = " " + postContent;
                else postContent = " " + postContent + "."; 
            }
            postText.textContent = postContent;
            
            questionText.appendChild(preText);
            questionText.appendChild(answerInput);
            questionText.appendChild(postText);
            
            questionWrapper.appendChild(questionText);
            container.appendChild(questionWrapper);
            
            const keyboardArea = document.createElement('div');
            keyboardArea.className = 'keyboard-area';
            keyboardArea.appendChild(buildKeyboard());
            
            const controls = document.createElement('div');
            controls.className = 'scramble-controls'; 
            
            const checkButton = document.createElement('button');
            checkButton.id = 'check-scramble-btn';
            checkButton.textContent = 'âœ” ØªÙØ­ÙÙ‚ÙÙ‘Ù‚Ù’';
            checkButton.onclick = () => { playSound('touch'); checkFillInBlankAnswer(data.a); };
            
            const resetButton = document.createElement('button');
            resetButton.id = 'reset-scramble-btn'; 
            resetButton.textContent = 'ğŸ”„ Ù…ÙØ³Ù’Ø­'; 
            resetButton.onclick = () => { playSound('touch'); const input = document.getElementById('answer-input'); if(input) input.textContent = ''; };

            controls.appendChild(checkButton);
            controls.appendChild(resetButton);
            keyboardArea.appendChild(controls);

            container.appendChild(keyboardArea);
            activityArea.appendChild(container);

            setTimeout(calculateGlobalFontSize, 100);
        }

        function buildKeyboard() {
            const keyboardContainer = document.createElement('div');
            keyboardContainer.className = 'keyboard-container';

            keyRows.forEach(row => {
                const keyRow = document.createElement('div');
                keyRow.className = 'key-row';
                row.forEach(keyText => {
                    const key = document.createElement('div');
                    key.className = 'key';
                    key.textContent = keyText;
                    
                    if (keyText === 'Backspace') {
                        key.classList.add('backspace');
                        key.innerHTML = 'âŒ«'; 
                        key.style.backgroundColor = backspaceBg;
                        key.style.boxShadow = `0 3px ${backspaceShadow}`; 
                        key.onclick = () => {
                            playSound('touch');
                            const answerInput = document.getElementById('answer-input');
                            if(answerInput) answerInput.textContent = answerInput.textContent.slice(0, -1);
                        };
                    } else {
                        const keyChar = keyText[0]; 
                        const color = colorMap[keyChar] || defaultColor;
                        key.style.backgroundColor = color;
                        key.style.boxShadow = `0 3px ${getDarkerColor(color)}`; 
                        key.onclick = () => {
                            playSound('touch');
                            const answerInput = document.getElementById('answer-input');
                            if(answerInput) answerInput.textContent += keyText;
                        };
                    }
                    keyRow.appendChild(key);
                });
                keyboardContainer.appendChild(keyRow);
            });
            return keyboardContainer;
        }

        function checkFillInBlankAnswer(correctAnswer) {
            const answerInput = document.getElementById('answer-input');
            const userAnswer = answerInput.textContent.trim();
            const normalizedUserAnswer = normalizeForCheck(userAnswer); 
            let isCorrect = false;
            const correctAnswers = Array.isArray(correctAnswer) ? correctAnswer : [correctAnswer];
            const normalizedCorrectAnswers = correctAnswers.map(normalizeForCheck); 

            for (const normCorrect of normalizedCorrectAnswers) { 
                if (normalizedUserAnswer === normCorrect) { isCorrect = true; break; }
                if (normCorrect.startsWith("Ø§Ù„")) {
                    const answerWithoutAl = normCorrect.substring(2); 
                    if (normalizedUserAnswer === answerWithoutAl) { isCorrect = true; break; }
                }
            }
            showFeedback(isCorrect, correctAnswers[0]); 
            if (isCorrect) scoreCorrect++; else scoreIncorrect++;
        }

        function showFeedback(isCorrect, correctAnswer) {
            feedbackOverlay.classList.add('show');
            if (isCorrect) {
                feedbackIcon.textContent = 'âœ”';
                feedbackIcon.className = 'correct';
                playSound('correct');
                feedbackDetails.style.display = 'none'; 
                setTimeout(nextActivity, 1200); 
            } else {
                feedbackIcon.textContent = 'âŒ';
                feedbackIcon.className = 'incorrect';
                playSound('incorrect');
                const answerToShow = (Array.isArray(correctAnswer) ? correctAnswer[0] : correctAnswer);
                feedbackCorrectAnswer.textContent = `Ø§Ù„Ù’Ø¬ÙÙˆØ§Ø¨ Ø§Ù„ØµÙ‘ÙØ­ÙŠØ­: ${answerToShow}`;
                feedbackDetails.style.display = 'flex'; 
                feedbackOkButton.onclick = () => { nextActivity(); };
            }
        }

        function nextActivity() {
            feedbackOverlay.classList.remove('show');
            feedbackDetails.style.display = 'none'; 
            currentActivityIndex++; 
            if (currentActivityIndex === grandTotalActivities) {
                if (currentRound === totalRounds) showFinishScreen();
                else showRoundCompleteScreen();
            } else {
                loadActivity();
            }
        }

        function showFinishScreen() {
            activityArea.innerHTML = `
                <div id="finish-screen">
                    <p style="font-size: var(--global-question-font-size);">Ø£ÙØ­Ù’Ø³ÙÙ†Ù’Øª! Ù„ÙÙ‚ÙØ¯ Ø£ÙÙƒÙ’Ù…ÙÙ„Ù’ØªÙ Ø¬ÙÙ…ÙŠØ¹ Ø§Ù„Ø£ÙÙ†Ù’Ø´ÙØ·ÙØ©.</p>
                    <p style="font-size: var(--global-question-font-size); color: #555;">Ø§Ù„Ù†Ù‘ÙØªÙÙŠØ¬ÙØ©Ù Ø§Ù„Ù†Ù‘ÙÙ‡ÙØ§Ø¦ÙÙŠÙ‘ÙØ©:</p>
                    <div class="score-display" style="font-size: var(--global-question-font-size);">
                        <span style="color:var(--success-color); margin-right:20px">âœ” ${scoreCorrect}</span>
                        <span style="color:var(--danger-color)">âŒ ${scoreIncorrect}</span>
                    </div>
                    <button id="replay-button" onclick="restartGame()">ğŸ”„</button>
                </div>`;
            instructionText.textContent = "";
            progressDisplay.textContent = "Ø§ÙÙƒÙ’ØªÙÙ…ÙÙ„";
            progressBar.style.width = '100%';
            progressBar.style.backgroundColor = 'var(--success-color)';
        }

        function showRoundCompleteScreen() {
            activityArea.innerHTML = `
                <div id="finish-screen">
                    <p style="font-size: var(--global-question-font-size);">Ø£ÙØ­Ù’Ø³ÙÙ†Ù’Øª!</p>
                    <p style="font-size: var(--global-question-font-size); color: #555;">Ù†ÙØªÙŠØ¬ÙØ© Ù‡ÙØ°ÙÙ‡Ù Ø§Ù„Ø¬ÙÙˆÙ’Ù„ÙØ©</p>
                    <div class="score-display" style="font-size: var(--global-question-font-size);">
                        <span style="color:var(--success-color); margin-right:20px">âœ” ${scoreCorrect}</span>
                        <span style="color:var(--danger-color)">âŒ ${scoreIncorrect}</span>
                    </div>
                    <button id="check-scramble-btn" onclick="startNextRound()" style="font-size: 2.5vh; margin-top: 20px;">Ø§Ù„ØªÙ‘ÙØ§Ù„ÙÙŠ â†</button>
                </div>`;
            instructionText.textContent = "Ø£ÙØ­Ù’Ø³ÙÙ†Ù’Øª!";
            progressDisplay.textContent = "Ø§ÙÙƒÙ’ØªÙÙ…ÙÙ„";
            progressBar.style.width = '100%';
            progressBar.style.backgroundColor = 'var(--success-color)';
        }

        function startNextRound() {
            playSound('touch');
            scoreCorrect = 0; scoreIncorrect = 0;
            currentRound++;
            currentActivityIndex = 0;
            const roundStartIndex = (currentRound - 1) * questionsPerRound;
            const roundEndIndex = Math.min(currentRound * questionsPerRound, totalQuestionsInGame);
            activityQueue = allActivitiesData.slice(roundStartIndex, roundEndIndex);
            grandTotalActivities = activityQueue.length;
            progressBar.style.width = '0%';
            progressBar.style.backgroundColor = 'var(--accent-color)';
            loadActivity(); 
        }

        function restartGame() {
            playSound('touch');
            scoreCorrect = 0; scoreIncorrect = 0;
            progressBar.style.width = '0%';
            progressBar.style.backgroundColor = 'var(--accent-color)';
            allActivitiesData = shuffle([...activitiesData]);
            totalQuestionsInGame = allActivitiesData.length;
            totalRounds = Math.ceil(totalQuestionsInGame / questionsPerRound);
            currentRound = 0; 
            
            findLongestData();

            startNextRound(); 
        }

        function updateProgress() {
            if (grandTotalActivities === 0) { progressDisplay.textContent = `0 / ${grandTotalActivities}`; return; }
            const currentTotal = currentActivityIndex + 1;
            const percentage = (currentActivityIndex / grandTotalActivities) * 100;
            progressDisplay.textContent = `${currentTotal} / ${grandTotalActivities}`;
            progressBar.style.width = `${percentage}%`;
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            allActivitiesData = shuffle([...activitiesData]);
            totalQuestionsInGame = allActivitiesData.length;
            totalRounds = Math.ceil(totalQuestionsInGame / questionsPerRound);
            scoreCorrect = 0; scoreIncorrect = 0;
            currentRound = 0; 
            
            findLongestData();

            startNextRound(); 
            checkFullScreen();

            setTimeout(calculateGlobalFontSize, 100);
        });
    </script>
</body>
</html>